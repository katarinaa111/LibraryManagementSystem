<div class="container-fluid">
  <!-- Page Heading -->
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
      <i class="fas fa-cog pr-2"></i>User Settings
    </h1>
  </div>

  <div class="row">
    <!-- Profile Card -->
    <div class="col-lg-4 mb-4">
      <div class="card shadow mb-4 text-center">
        <div class="card-body">
          <img
            src="assets/undraw_profile_1.svg"
            class="rounded-circle mb-3"
            width="120"
            height="120"
            alt="User"
          />
          <h5 class="mb-1" id="userName"></h5>
          <p class="text-muted small mb-3" id="userRole"></p>
        </div>
      </div>
    </div>

    <!-- Settings Form -->
    <div class="col-lg-8 mb-4">
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">Profile Information</h6>
        </div>
        <div class="card-body">
          <form id="settingsForm">
            <div class="form-group">
              <label for="fullName">Full Name</label>
              <input type="text" id="fullName" class="form-control" />
            </div>

            <div class="form-group">
              <label for="email">Email Address</label>
              <input type="email" id="email" class="form-control" />
            </div>

            <div class="form-group">
              <label for="role">Role</label>
              <select id="role" class="form-control" disabled>
                <option value="member">Member</option>
                <option value="admin">Admin</option>
              </select>
            </div>

            <hr />

            <button type="submit" class="btn btn-success">
              <i class="fas fa-save mr-1"></i> Save Changes
            </button>
            <button type="reset" class="btn btn-secondary ml-2">Reset</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  (function () {
    function setText(id, value) {
      var el = document.getElementById(id);
      if (el) el.textContent = value || "";
    }
    function setValue(id, value) {
      var el = document.getElementById(id);
      if (el) el.value = value || "";
    }
    function setDisabled(id, disabled) {
      var el = document.getElementById(id);
      if (el) el.disabled = !!disabled;
    }

    var currentUser = null;
    RestClient.get(
      "/users/me",
      function (resp) {
        var user = resp?.data || resp;
        if (!user) {
          alert("Failed to load user");
          return;
        }
        currentUser = user;
        var fn = user.firstName || "";
        var ln = user.lastName || "";
        var full = (fn + " " + ln).trim() || user.username || "";
        setValue("fullName", full);
        setValue("email", user.email || "");
        setText("userName", full || "");
        setValue("role", user.role || "");
        setText(
          "userRole",
          (user.role || "").charAt(0).toUpperCase() + (user.role || "").slice(1)
        );
        setDisabled("role", true);
        setDisabled("email", false);
        setDisabled("fullName", false);
      },
      function () {
        alert("Unauthorized. Please login again.");
      }
    );

    var form = document.getElementById("settingsForm");
    if (form) {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        var email = document.getElementById("email")?.value || "";
        var fullName = document.getElementById("fullName")?.value || "";
        var roleEl = document.getElementById("role");
        var role = roleEl ? roleEl.value : "";
        var emailValid = /.+@.+\..+/.test(email);
        if (!emailValid) {
          alert("Please enter a valid email");
          return;
        }
        var roleValid =
          ["admin", "member"].indexOf((role || "").toLowerCase()) !== -1;
        if (!roleValid) {
          alert("Invalid role");
          return;
        }
        if (!currentUser || !currentUser.id) {
          alert("Missing user context");
          return;
        }
        var parts = fullName.trim().split(/\s+/);
        var firstName = parts.shift() || "";
        var lastName = parts.join(" ") || "";
        var payload = {
          username: (fullName || "").trim() || currentUser.username || "",
          email: email,
          role: (role || "").toLowerCase(),
          firstName: firstName,
          lastName: lastName,
        };
        RestClient.put(
          "/users/" + currentUser.id,
          payload,
          function (response) {
            var updated = response?.data || response || payload;
            var uf =
              (updated.firstName || firstName || "") +
              (updated.lastName || lastName
                ? " " + (updated.lastName || lastName)
                : "");
            uf = uf.trim() || updated.username || payload.username;
            setValue("fullName", uf);
            setValue("email", updated.email || email);
            setText("userName", uf);
          },
          function (jq) {
            var msg =
              jq?.responseJSON?.error ||
              jq?.responseJSON?.message ||
              "Update failed";
            alert(msg);
          }
        );
      });
    }
  })();
</script>
