<div class="container-fluid">
  <!-- Page Heading -->
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
      <i class="fas fa-cog pr-2"></i>User Settings
    </h1>
  </div>

  <div class="row">
    <!-- Profile Card -->
    <div class="col-lg-4 mb-4">
      <div class="card shadow mb-4 text-center">
        <div class="card-body">
          <img
            src="assets/undraw_profile_1.svg"
            class="rounded-circle mb-3"
            width="120"
            height="120"
            alt="User"
          />
          <h5 class="mb-1" id="userName"></h5>
          <p class="text-muted small mb-3" id="userRole"></p>
        </div>
      </div>
    </div>

    <!-- Settings Form -->
    <div class="col-lg-8 mb-4">
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">Profile Information</h6>
        </div>
        <div class="card-body">
          <form id="settingsForm">
            <div class="form-group">
              <label for="fullName">Full Name</label>
              <input type="text" id="fullName" class="form-control" />
            </div>

            <div class="form-group">
              <label for="email">Email Address</label>
              <input type="email" id="email" class="form-control" />
            </div>

            <div class="form-group">
              <label for="role">Role</label>
              <select id="role" class="form-control" disabled>
                <option value="member">Member</option>
                <option value="admin">Admin</option>
              </select>
            </div>

            <hr />

            <div class="form-group">
              <label for="password">Change Password</label>
              <input
                type="password"
                id="password"
                class="form-control"
                placeholder="Enter new password"
              />
            </div>

            <div class="form-group">
              <label for="confirmPassword">Confirm Password</label>
              <input
                type="password"
                id="confirmPassword"
                class="form-control"
                placeholder="Confirm new password"
              />
            </div>

            <hr />

            <div class="form-group form-check">
              <input
                type="checkbox"
                class="form-check-input"
                id="emailNotifications"
                checked
              />
              <label class="form-check-label" for="emailNotifications"
                >Receive email notifications</label
              >
            </div>

            <button type="submit" class="btn btn-success">
              <i class="fas fa-save mr-1"></i> Save Changes
            </button>
            <button type="reset" class="btn btn-secondary ml-2">Reset</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  (function () {
    function setText(id, value) {
      var el = document.getElementById(id);
      if (el) el.textContent = value || "";
    }
    function setValue(id, value) {
      var el = document.getElementById(id);
      if (el) el.value = value || "";
    }
    function setDisabled(id, disabled) {
      var el = document.getElementById(id);
      if (el) el.disabled = !!disabled;
    }

    RestClient.get(
      "/users/me",
      function (resp) {
        var user = resp?.data || resp;
        if (!user) {
          alert("Failed to load user");
          return;
        }
        var fn = user.firstName || "";
        var ln = user.lastName || "";
        var full = (fn + " " + ln).trim() || user.username || "";
        setValue("fullName", full);
        setValue("email", user.email || "");
        setText("userName", full || "");
        setValue("role", user.role || "");
        setText(
          "userRole",
          (user.role || "").charAt(0).toUpperCase() + (user.role || "").slice(1)
        );
        setDisabled("role", true);
        if (user.role === "admin") {
          setDisabled("email", false);
          setDisabled("fullName", false);
        } else {
          setDisabled("email", true);
          setDisabled("fullName", true);
        }
      },
      function () {
        alert("Unauthorized. Please login again.");
      }
    );

    var form = document.getElementById("settingsForm");
    if (form) {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        var email = document.getElementById("email")?.value || "";
        var password = document.getElementById("password")?.value || "";
        var confirm = document.getElementById("confirmPassword")?.value || "";
        var roleEl = document.getElementById("role");
        var role = roleEl ? roleEl.value : "";
        var emailValid = /.+@.+\..+/.test(email);
        if (!emailValid) {
          alert("Please enter a valid email");
          return;
        }
        if (password) {
          if (password.length < 8) {
            alert("Password must be at least 8 characters");
            return;
          }
          if (password !== confirm) {
            alert("Passwords do not match");
            return;
          }
        }
        var roleValid =
          ["admin", "member"].indexOf((role || "").toLowerCase()) !== -1;
        if (!roleValid) {
          alert("Invalid role");
          return;
        }
        alert("Settings validated. Implement server update as needed.");
      });
    }
  })();
</script>
